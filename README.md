# WC3 map PoC - icon over healthbar

Based on WC3 TypeScript template [wc3-ts-template](https://cipherxof.github.io/w3ts/docs/getting-started).

## How to test map

* Install [Node.js](https://nodejs.org/en/download)
* In `config.json` update `gameExecutable` field to point to WC3 executable
* From root directory run:
    ```shell
    node install
    node run test
    ```

## Implementation overview

The over HP icon is a SpecialEffect whose position is updated every 0.01 seconds.

### HP bar position formula

#### X and Y axis

It is `GetUnitX()/GetUnitY()`, but the values are off by 16 units (half a tile?) for certain unit collision sizes

#### Z axis

The formula is:

`unit.z + unit.flyHeight + unit.modelHeight * unit.modelScale + 16.5`

`unit.z` - unit's Z axis position (`BlzGetUnitZ()/BlzGetLocalUnitZ()`);

`unit.modelHeight` - Z extent of unit's model (.mdx) `stand` animation/sequence (or first sequence if no stand
animations found).
This data comes from `unitModelHeightData.json`, which is generated by `scripts/extract-model-heights.ts`.
It that parses all units .mdx files.
Some of the data is overwritten manually in the `main.ts`.

`unit.modelScale` - runtime unit's scale. There seems to be no API to get runtime scale, so instead initial/unit type
scale is used (`BlzGetUnitRealField(u.handle, UNIT_RF_SCALING_VALUE)`).

### Using HP bar pivot to draw effect above HP bar

HP bar pivot position is different for HP and HP+MP bars.
For HP bar it is almost at the top of HP bar, but for HP+MP bar it is between bars.
Just drawing icon slightly higher (add Z offset to) results in icon shifting relative to HP bar
on certain camera angles.
To reduce this effect, we instead update Z position of effect's model (model uses `billboard` flag).
Its pivot point stays at (0,0,0) but the quad is moved up on Z axis (3 for HP and 15 for HP+MP).

## Drawbacks (compared to native AddSpecialEffectTarget())

* Requires precise model height data. Both for SD and HD models. Would require additional code to determine SD/HD mode.
* On flying units it does not align with HP bar when flying over ramp/uneven terrain.
* In shallow water the icon is higher than HP bar.
* Does not update after scale change (Bloodlust) or model change (Polymorph).
* Requires high frequency timer that might affect performance?

## Drawbacks of native AddSpecialEffectTarget()

* Inherits unit's model tint (e.g. on Forest Troll Berserker tints green) that can't be changed
* Position is based on model's 'overhead' attachment. Can result in hiding itself with HP bar (HP is drawn on top). Mitigation - place is much higher / use up/down animation?
* Bug? Disappears after polymorph

## Misc notes

* HP bar width is based on `selection circle` model and is effected by (Art - Selection Scale).
* With World2Screen API we could switch to using Frames API (2D on screen elements),
  but that would require more code to handle visibility, and a hit to performance.